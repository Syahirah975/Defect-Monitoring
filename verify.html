<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Defect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:Arial; background:#020617; color:#e5e7eb; padding:20px; }
h1 { color:#22c55e; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #1f2937; padding:5px; font-size:12px; text-align:center; }
th { background:#111827; }
input, select { width:100%; background:#111827; color:white; border:1px solid #1f2937; }
.green { background:#16a34a !important; }
.red { background:#dc2626 !important; }
.yellow { background:#facc15 !important; color:black; }
.locked { opacity:0.6; pointer-events:none; }
.day-label { font-size:10px; color:#93c5fd; margin-bottom:2px; display:block; }
a { color:#93c5fd; }
pre { white-space:pre-wrap; margin:0; }
</style>
</head>
<body>

<h1>✅ Verify Defect (PIC)</h1>
<p><a href="index.html">← Back to Submit</a></p>

<table>
<thead>
<tr>
  <th>Date</th>
  <th>Line</th>
  <th>Station</th>
  <th>Description</th>
  <th>Reject By</th>
  <th>PIC</th>
  <th>Status</th>
  <th colspan="14">14-Day Monitoring</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyB5EQudIAO9FsxMn6V1qPlawjBzhmlAU_M",
  authDomain: "defect-monitoring-34967.firebaseapp.com",
  databaseURL: "https://defect-monitoring-34967-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "defect-monitoring-34967"
});
const db = firebase.database();

/* ===== Helpers ===== */
function parseDate(dateStr){
  // Expect YYYY-MM-DD format
  const d = new Date(dateStr);
  d.setHours(0,0,0,0);
  return d;
}

function getDayDiff(startDate){
  const today = new Date();
  today.setHours(0,0,0,0);
  return Math.floor((today - startDate)/86400000);
}

function formatDateLabel(startDate, offset){
  const d = new Date(startDate);
  d.setDate(d.getDate() + offset);
  return d.toLocaleDateString("en-GB"); // DD/MM/YYYY
}

/* ===== Render Table ===== */
function renderTable(){
  db.ref("defects").once("value", snap=>{
    const body = document.getElementById("tableBody");
    body.innerHTML = "";

    snap.forEach(child=>{
      const d = child.val();
      const key = child.key;
      const startDate = parseDate(d.date);
      const dayDiff = getDayDiff(startDate);
      const locked = d.status === "Closed";

      let daysHTML = "";
      for(let i=0;i<14;i++){
        const val = d.days?.[i]?.value || "";
        const ver = d.days?.[i]?.verification || "";
        const future = i > dayDiff;
        const disabled = (future || locked) ? "disabled" : "";

        daysHTML += `<td>
          <span class="day-label">${formatDateLabel(startDate,i)}</span>
          <input type="number" min="0" value="${val}" ${disabled}
            oninput="updateDay('${key}',${i},this.value)">
          <select ${disabled} onchange="updateVerification('${key}',${i},this.value)">
            <option value=""></option>
            <option value="Verified" ${ver==='Verified'?'selected':''}>Verified</option>
            <option value="Reject" ${ver==='Reject'?'selected':''}>Reject</option>
          </select>
        </td>`;
      }

      body.innerHTML += `<tr class="${locked?'locked':''}">
        <td>${d.date}</td>
        <td>${d.line}</td>
        <td>${d.station}</td>
        <td><pre>${d.description}</pre></td>
        <td>${d.rejectBy}</td>
        <td><input value="${d.pic||''}" ${locked?'disabled':''} oninput="db.ref('defects/${key}/pic').set(this.value)"></td>
        <td>
          <select ${locked?'disabled':''} onchange="db.ref('defects/${key}/status').set(this.value)">
            <option></option>
            <option value="On Going" ${d.status==='On Going'?'selected':''}>On Going</option>
            <option value="Closed" ${d.status==='Closed'?'selected':''}>Closed</option>
          </select>
        </td>
        ${daysHTML}
      </tr>`;
    });

    applyColors();
    autoCloseDefects();
  });
}

/* ===== Update Functions ===== */
function updateDay(key,i,val){
  db.ref(`defects/${key}/days/${i}/value`).set(val);
  autoCloseDefects();
}

function updateVerification(key,i,val){
  db.ref(`defects/${key}/days/${i}/verification`).set(val);
  autoCloseDefects();
}

/* ===== Auto-Close Logic ===== */
function autoCloseDefects(){
  db.ref("defects").once("value", snap=>{
    snap.forEach(child=>{
      const d = child.val();
      if(d.status === "Closed") return;

      const startDate = parseDate(d.date);
      const dayDiff = getDayDiff(startDate);
      let allOk = true;
      for(let i=0;i<=dayDiff && i<14;i++){
        const val = d.days?.[i]?.value;
        const ver = d.days?.[i]?.verification;
        if(val !== "0" || ver !== "Verified"){
          allOk = false;
          break;
        }
      }

      if(allOk){
        db.ref(`defects/${child.key}/status`).set("Closed");
      }
    });
  });
}

/* ===== Apply Colors ===== */
function applyColors(){
  const rows = document.getElementById("tableBody").rows;
  for(let r=0;r<rows.length;r++){
    const row = rows[r];

    const statusSelect = row.cells[6].querySelector("select");
    statusSelect.className="";
    if(statusSelect.value==="On Going") statusSelect.classList.add("yellow");
    if(statusSelect.value==="Closed") statusSelect.classList.add("green");

    for(let i=0;i<14;i++){
      const cell = row.cells[7+i];
      if(!cell) continue;
      const val = cell.querySelector("input");
      const ver = cell.querySelector("select");

      val.className="";
      if(val.value==="0") val.classList.add("green");
      else if(val.value!=="") val.classList.add("red");

      ver.className="";
      if(ver.value==="Verified") ver.classList.add("green");
      if(ver.value==="Reject") ver.classList.add("red");
    }
  }
}

/* ===== Initial Load ===== */
renderTable();
</script>

</body>
</html>
