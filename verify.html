<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Defect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:Arial; background:#020617; color:#e5e7eb; padding:20px; }
h1 { color:#22c55e; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { border:1px solid #1f2937; padding:5px; font-size:12px; text-align:center; }
th { background:#111827; }
input, select { width:100%; background:#111827; color:white; border:1px solid #1f2937; }
.green { background:#16a34a !important; }
.red { background:#dc2626 !important; }
.yellow { background:#facc15 !important; color:black; }
a { color:#93c5fd; }
</style>
</head>
<body>

<h1>✅ Verify Defect (PIC)</h1>
<p><a href="index.html">← Back to Submit</a></p>

<table>
<thead>
<tr>
<th>Date</th>
<th>Line</th>
<th>Station</th>
<th>Description</th>
<th>Reject By</th>
<th>PIC</th>
<th>Status</th>
<th colspan="28">14-Day Monitoring (Value / Verification)</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyB5EQudIAO9FsxMn6V1qPlawjBzhmlAU_M",
  authDomain: "defect-monitoring-34967.firebaseapp.com",
  databaseURL: "https://defect-monitoring-34967-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "defect-monitoring-34967"
});
const db = firebase.database();

function renderRow(key, d) {
  // Ensure days array exists
  if(!d.days) d.days = Array(14).fill({value:'', verification:''});

  let daysHTML = "";
  for(let i=0;i<14;i++){
    const val = d.days[i]?.value || "";
    const ver = d.days[i]?.verification || "";

    daysHTML += `
      <td>
        <input value="${val}" oninput="updateDay('${key}', ${i}, this.value)">
        <select onchange="updateVerif('${key}', ${i}, this.value)">
          <option></option>
          <option ${ver==='Verified'?'selected':''}>Verified</option>
          <option ${ver==='Rejected'?'selected':''}>Rejected</option>
        </select>
      </td>
    `;
  }

  return `
  <tr id="row-${key}">
    <td>${d.date}</td>
    <td>${d.line}</td>
    <td>${d.station}</td>
    <td><pre style="white-space: pre-wrap;">${d.description}</pre></td>
    <td>${d.rejectBy}</td>
    <td><input value="${d.pic || ''}" oninput="updateField('${key}','pic',this.value)"></td>
    <td>
      <select onchange="updateField('${key}','status',this.value)">
        <option ${d.status==='In Progress'?'selected':''}>In Progress</option>
        <option ${d.status==='Closed'?'selected':''}>Closed</option>
      </select>
    </td>
    ${daysHTML}
  </tr>`;
}

// Apply colors dynamically
function applyColors() {
  const table = document.getElementById("tableBody");
  Array.from(table.rows).forEach(row => {
    // Status color
    const statusSelect = row.cells[6].querySelector("select");
    if(statusSelect.value==="In Progress") statusSelect.className="yellow";
    else if(statusSelect.value==="Closed") statusSelect.className="green";
    else statusSelect.className="";

    // Days + verification color
    for(let i=0;i<14;i++){
      const dayInput = row.cells[7+i*2].querySelector("input");
      const verifSelect = row.cells[7+i*2+1].querySelector("select");

      // Day
      if(dayInput.value==='0') dayInput.className="green";
      else if(dayInput.value!=='') dayInput.className="red";
      else dayInput.className="";

      // Verification
      if(verifSelect.value==="Verified") verifSelect.className="green";
      else if(verifSelect.value==="Rejected") verifSelect.className="red";
      else verifSelect.className="";
    }
  });
}

// Update Firebase
function updateField(key, field, val){
  db.ref(`defects/${key}/${field}`).set(val).then(applyColors);
}
function updateDay(key, index, val){
  db.ref(`defects/${key}/days/${index}/value`).set(val).then(applyColors);
}
function updateVerif(key, index, val){
  db.ref(`defects/${key}/days/${index}/verification`).set(val).then(applyColors);
}

// Listen to Firebase
db.ref("defects").on("value", snap=>{
  const body = document.getElementById("tableBody");
  body.innerHTML = "";
  snap.forEach(child=>{
    body.innerHTML += renderRow(child.key, child.val());
  });
  applyColors();
});
</script>
</body>
</html>
