<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Defect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
}
h1 { color: #22c55e; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #1f2937;
  padding: 6px;
  font-size: 12px;
  text-align: center;
}
th { background: #111827; }
input, select {
  width: 100%;
  background: #111827;
  color: white;
  border: 1px solid #1f2937;
}
a { color: #93c5fd; }
img { max-width: 50px; }
</style>
</head>

<body>

<h1>✅ Verify Defect (PIC)</h1>
<p><a href="submit.html">← Back to Submit</a></p>

<table>
<thead>
<tr>
<th>No</th>
<th>Date</th>
<th>Line</th>
<th>Station</th>
<th>Description</th>
<th>Photo</th>
<th>Reject By</th>
<th>PIC</th>
<th>Status</th>
<th colspan="28">14-Day Monitoring</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCVSK--rfS1YX3j4vo1ohk4cb05DSVYL2M",
  authDomain: "defect-monitoring-e0b0a.firebaseapp.com",
  databaseURL: "https://defect-monitoring-e0b0a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "defect-monitoring-e0b0a",
  storageBucket: "defect-monitoring-e0b0a.appspot.com",
  messagingSenderId: "839784520882",
  appId: "1:839784520882:web:da58fb06c994c67624bdab"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tbody = document.getElementById("tableBody");

db.ref("defects").on("value", snap => {
  tbody.innerHTML = "";
  let no = 1;

  snap.forEach(child => {
    const d = child.val();
    const id = child.key;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${no++}</td>
      <td>${d.date || ""}</td>
      <td>${d.line || ""}</td>
      <td>${d.station || ""}</td>
      <td>${d.description || ""}</td>
      <td>${d.photo ? `<img src="${d.photo}">` : "No Photo"}</td>
      <td>${d.rejectBy || ""}</td>

      <td>
        <input id="pic-${id}" value="${d.pic || ""}" 
        onchange="save('${id}')">
      </td>

      <td>
        <select id="status-${id}" onchange="save('${id}')">
          <option value=""></option>
          <option ${d.status==="In Progress"?"selected":""}>In Progress</option>
          <option ${d.status==="Closed"?"selected":""}>Closed</option>
        </select>
      </td>

      ${Array.from({length:14}).map((_,j)=>`
        <td id="daycell-${id}-${j}">
          <select id="val-${id}-${j}" onchange="save('${id}')">
            <option value=""></option>
            <option value="0" ${d.days?.[j]?.value==="0"?"selected":""}>0</option>
            ${Array.from({length:20}).map((_,n)=>`
              <option value="${n+1}" ${d.days?.[j]?.value===(n+1)+""?"selected":""}>${n+1}</option>
            `).join("")}
          </select>
        </td>
        <td id="verifcell-${id}-${j}">
          <select id="ver-${id}-${j}" onchange="save('${id}')">
            <option value=""></option>
            <option ${d.days?.[j]?.verification==="Verified"?"selected":""}>Verified</option>
            <option ${d.days?.[j]?.verification==="Rejected"?"selected":""}>Rejected</option>
          </select>
        </td>
      `).join("")}
    `;
    tbody.appendChild(row);
    applyColors(id);
  });
});

function save(id){
  const update = {
    pic: document.getElementById(`pic-${id}`).value,
    status: document.getElementById(`status-${id}`).value,
    days: []
  };

  for(let j=0;j<14;j++){
    update.days.push({
      value: document.getElementById(`val-${id}-${j}`).value,
      verification: document.getElementById(`ver-${id}-${j}`).value
    });
  }

  db.ref("defects/"+id).update(update);
  applyColors(id);
}

function applyColors(id){
  const status = document.getElementById(`status-${id}`);
  status.style.background =
    status.value==="In Progress" ? "yellow" :
    status.value==="Closed" ? "green" : "#111827";

  for(let j=0;j<14;j++){
    const val = document.getElementById(`val-${id}-${j}`);
    const cell = document.getElementById(`daycell-${id}-${j}`);
    if(val.value==="0") cell.style.background="green";
    else if(val.value!=="") cell.style.background="red";
    else cell.style.background="#111827";

    const ver = document.getElementById(`ver-${id}-${j}`);
    const vcell = document.getElementById(`verifcell-${id}-${j}`);
    if(ver.value==="Verified") vcell.style.background="green";
    else if(ver.value==="Rejected") vcell.style.background="red";
    else vcell.style.background="#111827";
  }
}
</script>

</body>
</html>



