<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Defect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
}
h1 { color: #22c55e; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #1f2937;
  padding: 6px;
  font-size: 12px;
  text-align: center;
}
th { background: #111827; }
input.day-input {
  width: 30px;
  text-align: center;
  background: #111827;
  color: white;
  border: 1px solid #1f2937;
}
.green { background: #16a34a !important; }
.red { background: #dc2626 !important; }
a { color: #93c5fd; }
img { max-width: 50px; display: block; margin: auto; }
</style>
</head>

<body>

<h1>✅ Verify Defect (PIC)</h1>
<p><a href="submit.html">← Back to Submit Page</a></p>

<table>
<thead>
<tr>
<th>No</th>
<th>Date</th>
<th>Line</th>
<th>Station</th>
<th>Description</th>
<th>Photo</th>
<th>Reject By</th>
<th colspan="14">14 Day Monitoring</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyB5EQudIAO9FsxMn6V1qPlawjBzhmlAU_M",
  authDomain: "defect-monitoring-34967.firebaseapp.com",
  databaseURL: "https://defect-monitoring-34967-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "defect-monitoring-34967"
});

const db = firebase.database();

/* ===== COLOR ===== */
function applyColor(input){
  input.classList.remove("green","red");
  if(input.value === "0") input.classList.add("green");
  else if(input.value !== "") input.classList.add("red");
}

/* ===== UPDATE DAY ===== */
function updateDay(key, index){
  const input = document.getElementById(`day-${key}-${index}`);
  db.ref(`defects/${key}/days/${index}`).set(input.value.trim());
  applyColor(input);
}

/* ===== RENDER ===== */
function render(){
  db.ref("defects").on("value", snap=>{
    const body = document.getElementById("tableBody");
    body.innerHTML = "";

    snap.forEach(child=>{
      const d = child.val();
      const key = child.key;
      if(!d.days) d.days = Array(14).fill("");

      let dayCols = "";
      d.days.forEach((val, i)=>{
        dayCols += `
        <td>
          <input class="day-input"
            id="day-${key}-${i}"
            value="${val}"
            oninput="updateDay('${key}',${i})">
        </td>`;
      });

      body.innerHTML += `
      <tr>
        <td>${d.no}</td>
        <td>${d.date}</td>
        <td>${d.line}</td>
        <td>${d.station}</td>
        <td><pre style="white-space:pre-wrap">${d.description}</pre></td>
        <td>${d.photo ? `<a href="${d.photo}" target="_blank"><img src="${d.photo}"></a>` : "No Photo"}</td>
        <td>${d.rejectBy}</td>
        ${dayCols}
      </tr>`;

      // apply colors after render
      d.days.forEach((_, i)=>{
        const input = document.getElementById(`day-${key}-${i}`);
        applyColor(input);
      });
    });
  });
}

render();
</script>

</body>
</html>
