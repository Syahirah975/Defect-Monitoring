<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Defect</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #020617;
  color: #e5e7eb;
  padding: 20px;
}
h1 { color: #22c55e; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #1f2937;
  padding: 6px;
  font-size: 12px;
  text-align: center;
}
th { background: #111827; }
input, select {
  width: 100%;
  background: #111827;
  color: white;
  border: 1px solid #1f2937;
}
a { color: #93c5fd; }
img { max-width: 50px; display:block; margin:auto; }
</style>
</head>

<body>

<h1>‚úÖ Verify Defect (PIC)</h1>
<p><a href="index.html">‚Üê Back to Submit Page</a></p>

<table>
<thead>
<tr>
<th>No</th>
<th>Date</th>
<th>Line</th>
<th>Station</th>
<th>Description</th>
<th>Photo</th>
<th>Reject By</th>
<th>PIC</th>
<th>Status</th>
<th colspan="28">14-Day Monitoring</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<button onclick="saveAll()">üíæ Save All</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* üî¥ USE SAME CONFIG AS submit.html */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "YOUR_DATABASE_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let defectKeys = [];

/* LOAD DATA */
function render() {
  db.ref("defects").once("value").then(snapshot => {
    const body = document.getElementById("tableBody");
    body.innerHTML = "";
    defectKeys = [];

    snapshot.forEach((child, i) => {
      const d = child.val();
      defectKeys.push(child.key);

      if (!d.days) d.days = Array(14).fill({ value:"", verification:"" });

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i+1}</td>
        <td>${d.date}</td>
        <td>${d.line}</td>
        <td>${d.station}</td>
        <td><pre style="white-space:pre-wrap">${d.description||""}</pre></td>
        <td>${d.photo ? `<img src="${d.photo}">` : "‚Äî"}</td>
        <td>${d.rejectBy}</td>
        <td><input id="pic-${i}" value="${d.pic||""}"></td>
        <td>
          <select id="status-${i}" onchange="applyColors()">
            <option ${d.status==="In Progress"?"selected":""}>In Progress</option>
            <option ${d.status==="Closed"?"selected":""}>Closed</option>
          </select>
        </td>
        ${Array.from({length:14}).map((_,j)=>`
          <td id="daycell-${i}-${j}">
            <input type="number" min="0" id="day-${i}-${j}"
              value="${d.days[j]?.value||""}" oninput="applyColors()">
          </td>
          <td id="verifcell-${i}-${j}">
            <select id="verif-${i}-${j}" onchange="applyColors()">
              <option></option>
              <option ${d.days[j]?.verification==="Verified"?"selected":""}>Verified</option>
              <option ${d.days[j]?.verification==="Rejected"?"selected":""}>Rejected</option>
            </select>
          </td>
        `).join("")}
      `;
      body.appendChild(row);
    });

    applyColors();
  });
}

/* SAVE */
function saveAll() {
  defectKeys.forEach((key,i)=>{
    const days = [];
    for(let j=0;j<14;j++){
      days.push({
        value: document.getElementById(`day-${i}-${j}`).value,
        verification: document.getElementById(`verif-${i}-${j}`).value
      });
    }
    db.ref("defects/"+key).update({
      pic: document.getElementById(`pic-${i}`).value,
      status: document.getElementById(`status-${i}`).value,
      days: days
    });
  });
  alert("Saved ‚úîÔ∏è");
}

/* COLORS */
function applyColors(){
  defectKeys.forEach((_,i)=>{
    const status = document.getElementById(`status-${i}`);
    status.style.background =
      status.value==="Closed" ? "green" :
      status.value==="In Progress" ? "yellow" : "#111827";

    for(let j=0;j<14;j++){
      const v = document.getElementById(`day-${i}-${j}`).value;
      document.getElementById(`daycell-${i}-${j}`).style.background =
        v==="0" ? "green" : v!=="" ? "red" : "#111827";

      const ver = document.getElementById(`verif-${i}-${j}`).value;
      document.getElementById(`verifcell-${i}-${j}`).style.background =
        ver==="Verified" ? "green" :
        ver==="Rejected" ? "red" : "#111827";
    }
  });
}

render();
</script>

</body>
</html>

